<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç†Šç†Šé˜¿å‰ç”Ÿå­—">
    
    <title>ç†Šç†Š é˜¿å‰å¯¶å¯å¤¢ç”Ÿå­—å¤§è€ƒé©—</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    
    <style>
        /* å…¨å±€è¨­å®š */
        body {
            margin: 0; padding: 0;
            background-color: #f0f4f8;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            overflow: hidden;
            height: 100vh; height: -webkit-fill-available;
            user-select: none; -webkit-user-select: none;
            touch-action: none; /* é˜²æ­¢æ»‘å‹• */
        }

        /* --- ç¬¬ 1 å±¤ï¼šåœ–é‘‘é¸å–®ä»‹é¢ --- */
        #menu-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #eef2f5;
            display: flex; flex-direction: column;
            z-index: 20; /* åœ¨æœ€ä¸Šå±¤ */
            overflow-y: auto; /* å…è¨±é¸å–®ä¸Šä¸‹æ²å‹• */
            -webkit-overflow-scrolling: touch; /* iOS æ²å‹•æµæš¢ */
            padding-bottom: 40px;
        }

        .menu-header {
            text-align: center; padding: 20px 10px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 30;
        }
        .menu-header h1 {
            margin: 0; font-size: 22px; color: #ffcb05; 
            -webkit-text-stroke: 1px #3b4cca;
            text-shadow: 2px 2px 0 #3b4cca;
            letter-spacing: 1px;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .menu-subtitle { font-size: 14px; color: #666; margin-top: 5px; }

        #pokemon-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* é€™è£¡è¨­å®šä¸€è¡Œå¹¾å€‹ï¼Œæ‰‹æ©Ÿè¨­3å€‹å‰›å¥½ */
            gap: 15px;
            padding: 20px;
            touch-action: pan-y; /* å…è¨±é¸å–®å€åŸŸå‚ç›´æ²å‹• */
        }

        .poke-card {
            background: white; border-radius: 15px;
            padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            cursor: pointer;
            position: relative;
        }
        .poke-card:active { transform: scale(0.95); }
        
        /* æ–°å¢ï¼šç·¨è™Ÿæ¨£å¼ */
        .poke-id { 
            position: absolute; top: 5px; left: 8px; 
            font-size: 10px; color: #999; font-family: monospace; font-weight: bold;
        }

        .poke-img {
            width: 80px; height: 80px; object-fit: contain;
            transition: filter 0.3s;
            margin-top: 10px; /* ç‚ºäº†é¿é–‹ç·¨è™Ÿç¨å¾®å¾€ä¸‹ */
        }

        /* æœªè§£é–æ¨£å¼ï¼šå…¨é»‘å‰ªå½± */
        .locked .poke-img {
            filter: brightness(0) opacity(0.8); 
        }
        .locked .poke-name {
            color: #ccc;
        }
        
        /* å·²è§£é–æ¨£å¼ */
        .unlocked .poke-img {
            filter: none;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.6)); /* é‡‘è‰²å…‰æšˆ */
        }
        .unlocked .poke-name {
            color: #333; font-weight: bold;
        }
        .unlocked::after {
            content: "ğŸ‘‘"; position: absolute; top: -5px; right: -5px; font-size: 20px;
        }

        .poke-name { margin-top: 5px; font-size: 14px; text-align: center; }

        /* --- ç¬¬ 2 å±¤ï¼šéŠæˆ²ç·´ç¿’ä»‹é¢ (é è¨­éš±è—) --- */
        #game-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* éš±è— */
            flex-direction: column; align-items: center; justify-content: center;
            background-color: #f0f4f8;
            z-index: 10;
        }

        #canvas-container {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-radius: 20px;
            overflow: hidden; background: white;
            position: relative;
            margin: 10px;
        }

        .ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 15px; box-sizing: border-box;
        }

        .game-header {
            text-align: center; background: rgba(255,255,255,0.9);
            border-radius: 15px; padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .game-header h2 { margin: 0; font-size: 24px; color: #333; }

        .game-footer {
            text-align: center; pointer-events: auto; padding-bottom: 20px;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }

        .btn {
            background: #ffcb05; border: 3px solid #3b4cca; color: #3b4cca;
            padding: 8px 20px; font-size: 16px; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 4px 0 #2a3693;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #2a3693; }
        .btn-red { background: #fff; border-color: #ff5555; color: #ff5555; box-shadow: 0 4px 0 #cc0000; }
        .btn-red:active { box-shadow: 0 0 0 #cc0000; }

        #progress-bar {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 200px; height: 10px; background: #eee; border-radius: 10px;
            border: 2px solid #ccc; overflow: hidden;
        }
        #progress-fill { height: 100%; width: 0%; background: #4caf50; transition: width 0.2s; }

        /* --- çå‹µå½ˆçª— --- */
        #reward-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; justify-content: center; align-items: center;
            animation: fadeIn 0.3s;
        }
        .reward-card {
            background: white; padding: 25px; border-radius: 25px;
            text-align: center; width: 80%; max-width: 320px;
            box-shadow: 0 0 30px rgba(255, 203, 5, 0.5);
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 5px solid #ffcb05;
        }
        .reward-card img { width: 220px; height: 220px; object-fit: contain; }
        .reward-text { font-size: 24px; font-weight: bold; color: #d32f2f; margin: 10px 0; }
        .reward-sub { font-size: 16px; color: #555; margin-bottom: 20px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popUp { from { transform: scale(0.5); } to { transform: scale(1); } }

    </style>
</head>
<body>

    <div id="menu-layer">
        <div class="menu-header">
            <h1>ğŸ» ç†Šç†Š é˜¿å‰ ğŸ‘¸<br>å¯¶å¯å¤¢ç”Ÿå­—å¤§è€ƒé©—</h1>
            <div class="menu-subtitle">é»æ“Šé»‘è‰²å½±å­é–‹å§‹æŒ‘æˆ°ï¼</div>
        </div>
        <div id="pokemon-grid">
            </div>
    </div>

    <div id="game-layer">
        <div id="canvas-container">
            <div class="ui-overlay">
                <div class="game-header">
                    <h2 id="question-text">é¡Œç›®</h2>
                </div>
                <div id="progress-bar"><div id="progress-fill"></div></div>
                <div class="game-footer">
                    <button class="btn btn-red" onclick="returnToMenu()">æ”¾æ£„</button>
                    <button class="btn btn-red" onclick="resetCanvas()">é‡å¯«</button>
                    <button class="btn" id="next-btn" onclick="nextStep()">ä¸‹ä¸€å­—</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reward-popup">
        <div class="reward-card">
            <h2 style="color:#ffcb05; -webkit-text-stroke:1px #2a3693; margin:0;">CONGRATS!</h2>
            <img id="reward-img" src="" alt="">
            <div class="reward-text" id="reward-msg">æ•ç² çš®å¡ä¸˜ !</div>
            <button class="btn" onclick="closeRewardAndReturn()">å¤ªæ£’äº†!</button>
        </div>
    </div>

<script>
    // --- éŠæˆ²è³‡æ–™ (50éš») ---
    // imageId å°æ‡‰ PokeAPI ç·¨è™Ÿ
    const vocabulary = [
        // å¿…å‚™ & ç†±é–€
        { word: "çš®å¡ä¸˜", zhuyin: ["ã„†ã„§ËŠ","ã„ã„šË‡","ã„‘ã„§ã„¡"], color: "#F7D02C", imageId: "25", id: 25 },
        { word: "è·¯å¡åˆ©æ­", zhuyin: ["ã„Œã„¨Ë‹","ã„ã„šË‡","ã„Œã„§Ë‹","ã„¡"], color: "#448CCB", imageId: "448", id: 448 },
        // ä¼Šå¸ƒå®¶æ—
        { word: "ä¼Šå¸ƒ", zhuyin: ["ã„§","ã„…ã„¨Ë‹"], color: "#A8A77A", imageId: "133", id: 133 },
        { word: "æ°´ä¼Šå¸ƒ", zhuyin: ["ã„•ã„¨ã„ŸË‡","ã„§","ã„…ã„¨Ë‹"], color: "#6890F0", imageId: "134", id: 134 },
        { word: "é›·ä¼Šå¸ƒ", zhuyin: ["ã„Œã„ŸËŠ","ã„§","ã„…ã„¨Ë‹"], color: "#F8D030", imageId: "135", id: 135 },
        { word: "ç«ä¼Šå¸ƒ", zhuyin: ["ã„ã„¨ã„›Ë‡","ã„§","ã„…ã„¨Ë‹"], color: "#F08030", imageId: "136", id: 136 },
        { word: "å¤ªé™½ä¼Šå¸ƒ", zhuyin: ["ã„Šã„Ë‹","ã„§ã„¤ËŠ","ã„§","ã„…ã„¨Ë‹"], color: "#A890F0", imageId: "196", id: 196 },
        { word: "æœˆäº®ä¼Šå¸ƒ", zhuyin: ["ã„©ã„Ë‹","ã„Œã„§ã„¤Ë‹","ã„§","ã„…ã„¨Ë‹"], color: "#705848", imageId: "197", id: 197 },
        { word: "è‘‰ä¼Šå¸ƒ", zhuyin: ["ã„§ã„Ë‹","ã„§","ã„…ã„¨Ë‹"], color: "#78C850", imageId: "470", id: 470 },
        { word: "å†°ä¼Šå¸ƒ", zhuyin: ["ã„…ã„§ã„¥","ã„§","ã„…ã„¨Ë‹"], color: "#98D8D8", imageId: "471", id: 471 },
        { word: "ä»™å­ä¼Šå¸ƒ", zhuyin: ["ã„’ã„§ã„¢","ã„—Ë‡","ã„§","ã„…ã„¨Ë‹"], color: "#F85888", imageId: "700", id: 700 },
        // å…¶ä»–å¯¶å¯å¤¢
        { word: "å¦™è›™ç¨®å­", zhuyin: ["ã„‡ã„§ã„ Ë‹","ã„¨ã„š","ã„“ã„¨ã„¥Ë‡","ã„—Ë‡"], color: "#78C850", imageId: "1", id: 1 },
        { word: "å°ç«é¾", zhuyin: ["ã„’ã„§ã„ Ë‡","ã„ã„¨ã„›Ë‡","ã„Œã„¨ã„¥ËŠ"], color: "#F08030", imageId: "4", id: 4 },
        { word: "å‚‘å°¼é¾œ", zhuyin: ["ã„ã„§ã„ËŠ","ã„‹ã„§ËŠ","ã„ã„¨ã„Ÿ"], color: "#6890F0", imageId: "7", id: 7 },
        { word: "ç¶ æ¯›èŸ²", zhuyin: ["ã„Œã„©Ë‹","ã„‡ã„ ËŠ","ã„”ã„¨ã„¥ËŠ"], color: "#78C850", imageId: "10", id: 10 },
        { word: "å·´å¤§è¶", zhuyin: ["ã„…ã„š","ã„‰ã„šË‹","ã„‰ã„§ã„ËŠ"], color: "#A8B820", imageId: "12", id: 12 },
        { word: "ç¨è§’èŸ²", zhuyin: ["ã„‰ã„¨ËŠ","ã„ã„§ã„ Ë‡","ã„”ã„¨ã„¥ËŠ"], color: "#A040A0", imageId: "13", id: 13 },
        { word: "æ³¢æ³¢", zhuyin: ["ã„…ã„›","ã„…ã„›"], color: "#A890F0", imageId: "16", id: 16 },
        { word: "é˜¿æŸè›‡", zhuyin: ["ã„š","ã„…ã„›ËŠ","ã„•ã„œËŠ"], color: "#A040A0", imageId: "23", id: 23 },
        { word: "ç©¿å±±é¼ ", zhuyin: ["ã„”ã„¨ã„¢","ã„•ã„¢","ã„•ã„¨Ë‡"], color: "#E0C068", imageId: "27", id: 27 },
        { word: "å°¼å¤šè˜­", zhuyin: ["ã„‹ã„§ËŠ","ã„‰ã„¨ã„›","ã„Œã„¢ËŠ"], color: "#A040A0", imageId: "29", id: 29 },
        { word: "çš®çš®", zhuyin: ["ã„†ã„§ËŠ","ã„†ã„§ËŠ"], color: "#F85888", imageId: "35", id: 35 },
        { word: "å…­å°¾", zhuyin: ["ã„Œã„§ã„¡Ë‹","ã„¨ã„ŸË‡"], color: "#F08030", imageId: "37", id: 37 },
        { word: "èƒ–ä¸", zhuyin: ["ã„†ã„¤Ë‹","ã„‰ã„§ã„¥"], color: "#F85888", imageId: "39", id: 39 },
        { word: "èµ°è·¯è‰", zhuyin: ["ã„—ã„¡Ë‡","ã„Œã„¨Ë‹","ã„˜ã„ Ë‡"], color: "#78C850", imageId: "43", id: 43 },
        { word: "å–µå–µ", zhuyin: ["ã„‡ã„§ã„ ","ã„‡ã„§ã„ "], color: "#A8A878", imageId: "52", id: 52 },
        { word: "å¯é”é´¨", zhuyin: ["ã„ã„œË‡","ã„‰ã„šËŠ","ã„§ã„š"], color: "#F8D030", imageId: "54", id: 54 },
        { word: "çŒ´æ€ª", zhuyin: ["ã„ã„¡ËŠ","ã„ã„¨ã„Ë‹"], color: "#C03028", imageId: "56", id: 56 },
        { word: "å¡è’‚ç‹—", zhuyin: ["ã„ã„šË‡","ã„‰ã„§Ë‹","ã„ã„¡"], color: "#F08030", imageId: "58", id: 58 },
        { word: "èšŠé¦™èŒèšª", zhuyin: ["ã„¨ã„£ËŠ","ã„’ã„§ã„¤","ã„ã„œ","ã„‰ã„¡Ë‡"], color: "#6890F0", imageId: "60", id: 60 },
        { word: "å‡±è¥¿", zhuyin: ["ã„ã„Ë‡","ã„’ã„§"], color: "#F85888", imageId: "63", id: 63 },
        { word: "è…•åŠ›", zhuyin: ["ã„¨ã„¢Ë‹","ã„Œã„§Ë‹"], color: "#C03028", imageId: "66", id: 66 },
        { word: "å°æ‹³çŸ³", zhuyin: ["ã„’ã„§ã„ Ë‡","ã„‘ã„©ã„¢ËŠ","ã„•ËŠ"], color: "#E0C068", imageId: "74", id: 74 },
        { word: "å°ç£æ€ª", zhuyin: ["ã„’ã„§ã„ Ë‡","ã„˜ËŠ","ã„ã„¨ã„Ë‹"], color: "#B8B8D0", imageId: "81", id: 81 },
        { word: "å¤§è”¥é´¨", zhuyin: ["ã„‰ã„šË‹","ã„˜ã„¨ã„¥","ã„§ã„š"], color: "#A8A878", imageId: "83", id: 83 },
        { word: "å˜Ÿå˜Ÿ", zhuyin: ["ã„‰ã„¨","ã„‰ã„¨"], color: "#A890F0", imageId: "84", id: 84 },
        { word: "å°æµ·ç…", zhuyin: ["ã„’ã„§ã„ Ë‡","ã„ã„Ë‡","ã„•"], color: "#6890F0", imageId: "86", id: 86 },
        { word: "å¤§å²©è›‡", zhuyin: ["ã„‰ã„šË‹","ã„§ã„¢ËŠ","ã„•ã„œËŠ"], color: "#A8A878", imageId: "95", id: 95 },
        { word: "å¤§é‰—èŸ¹", zhuyin: ["ã„‰ã„šË‹","ã„‘ã„§ã„¢ËŠ","ã„’ã„§ã„Ë‹"], color: "#6890F0", imageId: "98", id: 98 },
        { word: "é›·çƒ", zhuyin: ["ã„Œã„ŸËŠ","ã„‘ã„§ã„¡ËŠ"], color: "#F8D030", imageId: "100", id: 100 },
        { word: "å¯æ‹‰å¯æ‹‰", zhuyin: ["ã„ã„œË‡","ã„Œã„š","ã„ã„œË‡","ã„Œã„š"], color: "#E0C068", imageId: "104", id: 104 },
        { word: "å¢¨æµ·é¦¬", zhuyin: ["ã„‡ã„›Ë‹","ã„ã„Ë‡","ã„‡ã„šË‡"], color: "#6890F0", imageId: "116", id: 116 },
        { word: "æµ·æ˜Ÿæ˜Ÿ", zhuyin: ["ã„ã„Ë‡","ã„’ã„§ã„¥","ã„’ã„§ã„¥"], color: "#6890F0", imageId: "120", id: 120 },
        { word: "é¯‰é­šç‹", zhuyin: ["ã„Œã„§Ë‡","ã„©ËŠ","ã„¨ã„¤ËŠ"], color: "#F05030", imageId: "129", id: 129 },
        { word: "ç™¾è®Šæ€ª", zhuyin: ["ã„…ã„Ë‡","ã„…ã„§ã„¢Ë‹","ã„ã„¨ã„Ë‹"], color: "#A8A878", imageId: "132", id: 132 },
        { word: "å¡æ¯”ç¸", zhuyin: ["ã„ã„šË‡","ã„…ã„§Ë‡","ã„•ã„¡Ë‹"], color: "#303842", imageId: "143", id: 143 },
        { word: "å¿«é¾", zhuyin: ["ã„ã„¨ã„Ë‹","ã„Œã„¨ã„¥ËŠ"], color: "#F0B666", imageId: "149", id: 149 },
        { word: "è¶…å¤¢", zhuyin: ["ã„”ã„ ","ã„‡ã„¥Ë‹"], color: "#9668C9", imageId: "150", id: 150 },
        { word: "å¤¢å¹»", zhuyin: ["ã„‡ã„¥Ë‹","ã„ã„¨ã„¢Ë‹"], color: "#F85888", imageId: "151", id: 151 },
        { word: "èŠè‰è‘‰", zhuyin: ["ã„ã„©ËŠ","ã„˜ã„ Ë‡","ã„§ã„Ë‹"], color: "#78C850", imageId: "152", id: 152 },
        { word: "ç«çƒé¼ ", zhuyin: ["ã„ã„¨ã„›Ë‡","ã„‘ã„§ã„¡ËŠ","ã„•ã„¨Ë‡"], color: "#F08030", imageId: "155", id: 155 },
        { word: "æ³¢å…‹æ¯”", zhuyin: ["ã„…ã„›","ã„ã„œË‹","ã„…ã„§Ë‡"], color: "#F85888", imageId: "175", id: 175 }
    ];

    // ç‚ºæ‰€æœ‰é …ç›®åŠ ä¸Šè§£é–ç‹€æ…‹
    vocabulary.forEach(v => v.isUnlocked = false);

    let currentIndex = 0; // ç›®å‰é¸æ“‡çš„å¯¶å¯å¤¢ index
    let charIndex = 0;    // ç›®å‰å¯«åˆ°ç¬¬å¹¾å€‹å­—
    
    // P5.js è®Šæ•¸
    let pgTarget, pgDraw;
    let particles = [];
    let canvasSize;
    let isWin = false;
    let STROKE_SIZE = 32; // ç­†ç•«è¼ƒç´°
    let TARGET_FONT_SIZE, ZHUYIN_FONT_SIZE;
    let p5Canvas;

    // --- ç¨‹å¼å…¥å£ ---
    function setup() {
        // åˆå§‹åŒ–ç•«å¸ƒï¼Œä½†å…ˆä¸é¡¯ç¤º (å› ç‚ºåœ¨ Menu å±¤)
        let w = window.innerWidth;
        let h = window.innerHeight;
        // ç•™ç©ºé–“çµ¦ UI
        canvasSize = Math.min(w, h * 0.75) - 30; 
        
        let cnv = createCanvas(canvasSize, canvasSize);
        cnv.parent('canvas-container');
        p5Canvas = cnv;

        // è¨ˆç®—å­—é«”å¤§å°
        TARGET_FONT_SIZE = canvasSize * 0.55;
        ZHUYIN_FONT_SIZE = TARGET_FONT_SIZE * 0.22;

        pgTarget = createGraphics(canvasSize, canvasSize);
        pgDraw = createGraphics(canvasSize, canvasSize);

        // å­—å‹è¨­å®š
        let fontName = "-apple-system, 'Microsoft JhengHei', sans-serif";
        textFont(fontName);
        pgTarget.textFont(fontName);

        // æ¸²æŸ“é¸å–®
        renderMenu();
    }

    function draw() {
        // åªæœ‰åœ¨éŠæˆ²å±¤é¡¯ç¤ºæ™‚æ‰ç¹ªè£½ï¼Œç¯€çœæ•ˆèƒ½
        if (document.getElementById('game-layer').style.display === 'none') return;

        background(255);
        drawGrid();
        drawGuideCharacter(); // åŒ…å«ç›´å¼æ³¨éŸ³
        image(pgDraw, 0, 0);
        handleParticles();

        if (mouseIsPressed && !isWin) {
            handleDrawing();
        }

        if (frameCount % 10 === 0 && !isWin) {
            checkWinCondition();
        }

        if (isWin) {
            winEffect();
        }
    }

    // --- 1. é¸å–®é‚è¼¯ ---
    function renderMenu() {
        const grid = document.getElementById('pokemon-grid');
        grid.innerHTML = ''; // æ¸…ç©º

        vocabulary.forEach((poke, index) => {
            const card = document.createElement('div');
            // æ ¹æ“šæ˜¯å¦è§£é–åŠ å…¥æ¨£å¼ class
            card.className = `poke-card ${poke.isUnlocked ? 'unlocked' : 'locked'}`;
            card.onclick = () => selectPokemon(index);

            // åŠ å…¥ ID é¡¯ç¤º
            const idTag = document.createElement('div');
            idTag.className = 'poke-id';
            idTag.innerText = 'No.' + String(poke.id).padStart(3, '0');

            const img = document.createElement('img');
            img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${poke.imageId}.png`;
            img.className = 'poke-img';
            img.loading = "lazy"; // åœ–ç‰‡æ‡¶åŠ è¼‰

            const name = document.createElement('div');
            name.className = 'poke-name';
            // æœªè§£é–é¡¯ç¤º ï¼Ÿï¼Ÿï¼Ÿ
            name.innerText = poke.isUnlocked ? poke.word : "???";

            card.appendChild(idTag); // åŠ å…¥ ID
            card.appendChild(img);
            card.appendChild(name);
            grid.appendChild(card);
        });
    }

    function selectPokemon(index) {
        currentIndex = index;
        charIndex = 0;
        
        // åˆ‡æ›ä»‹é¢
        document.getElementById('menu-layer').style.display = 'none';
        document.getElementById('game-layer').style.display = 'flex';
        
        // åˆå§‹åŒ–éŠæˆ²
        resetCanvas();
        prepareLevel();
        updateGameUI();
    }

    function returnToMenu() {
        document.getElementById('game-layer').style.display = 'none';
        document.getElementById('menu-layer').style.display = 'flex';
        renderMenu(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç‹€æ…‹
    }

    // --- 2. éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
    function prepareLevel() {
        pgDraw.clear();
        isWin = false;
        
        pgTarget.clear();
        pgTarget.fill(0);
        pgTarget.noStroke();
        pgTarget.textAlign(CENTER, CENTER);
        
        // ç•«å‡ºç›®æ¨™å­— (é»‘è‰²ï¼Œç”¨æ–¼åˆ¤å®š)
        let data = vocabulary[currentIndex];
        let char = data.word[charIndex];
        
        pgTarget.textSize(TARGET_FONT_SIZE);
        // å­—ç¨å¾®åå·¦ï¼Œç•™ç©ºé–“çµ¦å³é‚Šçš„ç›´å¼æ³¨éŸ³
        pgTarget.text(char, width/2 - TARGET_FONT_SIZE*0.15, height/2 - TARGET_FONT_SIZE*0.05);

        document.getElementById("progress-fill").style.width = "0%";
        document.getElementById("progress-fill").style.background = "#4caf50";
        document.getElementById("next-btn").innerText = "ä¸‹ä¸€å­—";
        document.getElementById("next-btn").style.display = "block";
    }

    // é‡é»ï¼šç›´å¼æ³¨éŸ³ç¹ªè£½
    function drawGuideCharacter() {
        let data = vocabulary[currentIndex];
        let char = data.word[charIndex];
        let zhuyinStr = data.zhuyin[charIndex]; // ä¾‹å¦‚ "ã„†ã„§ËŠ"

        let charX = width/2 - TARGET_FONT_SIZE*0.15;
        let charY = height/2 - TARGET_FONT_SIZE*0.05;

        // 1. ç•«åœ‹å­—åº•
        push();
        textAlign(CENTER, CENTER);
        fill(240); noStroke();
        textSize(TARGET_FONT_SIZE);
        text(char, charX, charY);
        
        noFill(); stroke(220); strokeWeight(3);
        text(char, charX, charY);

        // 2. ç•«ç›´å¼æ³¨éŸ³
        // æ³¨éŸ³èµ·å§‹ X ä½ç½® (åœ¨åœ‹å­—å³é‚Š)
        let zhuyinX = charX + TARGET_FONT_SIZE * 0.65;
        // èµ·å§‹ Y ä½ç½® (ç¨å¾®å¾€ä¸Šæä¸€é»ï¼Œè®“æ•´é«”ç½®ä¸­)
        let totalHeight = zhuyinStr.length * ZHUYIN_FONT_SIZE * 1.1; 
        let startY = charY - (totalHeight / 2) + (ZHUYIN_FONT_SIZE/2);

        fill(100); noStroke();
        textSize(ZHUYIN_FONT_SIZE);
        
        // è¿´åœˆæ‹†è§£å­—ä¸²ï¼Œä¸€å€‹å­—ä¸€å€‹å­—å‚ç›´å¾€ä¸‹ç•«
        for (let i = 0; i < zhuyinStr.length; i++) {
            let zChar = zhuyinStr[i];
            text(zChar, zhuyinX, startY + (i * ZHUYIN_FONT_SIZE * 1.1));
        }
        pop();
    }

    function handleDrawing() {
        pgDraw.stroke(vocabulary[currentIndex].color);
        pgDraw.strokeWeight(STROKE_SIZE);
        pgDraw.strokeCap(ROUND); pgDraw.strokeJoin(ROUND);

        if (pmouseX > 0 || pmouseY > 0) {
            let d = dist(pmouseX, pmouseY, mouseX, mouseY);
            // è£œé–“æ’é»è®“ç·šæ¢æ›´æ»‘é †
            if (d > 0) {
                 let steps = Math.ceil(d / 5);
                 for (let i = 0; i <= steps; i++) {
                     let x = lerp(pmouseX, mouseX, i/steps);
                     let y = lerp(pmouseY, mouseY, i/steps);
                     pgDraw.line(x, y, x, y); // ç”¨ line(x,y,x,y) æ¯” point æ•ˆèƒ½å¥½ä¸”é…åˆ strokeCap
                 }
            }
        }
        
        // ç²’å­
        if (dist(mouseX, mouseY, pmouseX, pmouseY) > 2) {
             particles.push(new Particle(mouseX, mouseY, vocabulary[currentIndex].color));
        }
    }

    function checkWinCondition() {
        pgTarget.loadPixels();
        pgDraw.loadPixels();
        let targetCount = 0, coveredCount = 0;
        const step = 40; 
        
        for (let i = 0; i < pgTarget.pixels.length; i += step) {
            if (pgTarget.pixels[i+3] > 100) {
                targetCount++;
                if (pgDraw.pixels[i+3] > 100) coveredCount++;
            }
        }

        let ratio = targetCount > 0 ? coveredCount / targetCount : 0;
        let percent = Math.min(Math.floor(ratio * 100), 100);
        document.getElementById("progress-fill").style.width = percent + "%";

        if (ratio > 0.85) {
            gameWin();
        }
    }

    function gameWin() {
        isWin = true;
        document.getElementById("progress-fill").style.background = "linear-gradient(90deg, #FFD700, #FFA500)";
        
        // ç‰¹æ•ˆ
        for(let i=0; i<30; i++) particles.push(new Particle(width/2, height/2, vocabulary[currentIndex].color));
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºæœ€å¾Œä¸€å€‹å­—
        if (charIndex >= vocabulary[currentIndex].word.length - 1) {
            document.getElementById("next-btn").innerText = "ğŸ‰ æ•ç²!";
            // å»¶é²è·³å‡ºçå‹µ
            setTimeout(showReward, 800);
        }
    }

    function nextStep() {
        if (!isWin) return; // æœªå®Œæˆä¸èƒ½è·³

        if (charIndex < vocabulary[currentIndex].word.length - 1) {
            // é‚„æœ‰å­—
            charIndex++;
            resetCanvas();
            prepareLevel();
            updateGameUI();
        } else {
            // å·²ç¶“æ˜¯æœ€å¾Œä¸€å€‹å­—ï¼Œè§¸ç™¼çå‹µ (æŒ‰éˆ•æ–‡å­—å·²ç¶“è®Šäº†)
            showReward();
        }
    }

    // --- 3. çå‹µèˆ‡ UI ---
    function showReward() {
        let data = vocabulary[currentIndex];
        
        // è¨­å®šå½ˆçª—å…§å®¹
        document.getElementById("reward-img").src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${data.imageId}.png`;
        document.getElementById("reward-msg").innerText = `æ•ç² ${data.word} !`;
        document.getElementById("reward-popup").style.display = "flex";

        // æ›´æ–°è³‡æ–™ç‹€æ…‹
        vocabulary[currentIndex].isUnlocked = true;

        // èƒŒæ™¯ç…™ç«
        for(let i=0; i<50; i++) particles.push(new Particle(random(width), random(height), data.color));
    }

    function closeRewardAndReturn() {
        document.getElementById("reward-popup").style.display = "none";
        returnToMenu();
    }

    function updateGameUI() {
        let data = vocabulary[currentIndex];
        document.getElementById('question-text').innerHTML = `
            <span style="color:#555">é¡Œç›®ï¼š</span>
            <span style="color:${data.color}; font-size:1.2em;">${data.word}</span>
        `;
    }

    window.resetCanvas = function() {
        pgDraw.clear();
        isWin = false;
        document.getElementById("progress-fill").style.width = "0%";
        document.getElementById("progress-fill").style.background = "#4caf50";
    }

    function drawGrid() {
        push();
        stroke(255, 220, 220); strokeWeight(2);
        rect(1, 1, width-2, height-2);
        drawingContext.setLineDash([8, 8]);
        line(width/2, 0, width/2, height);
        line(0, height/2, width, height/2);
        pop();
    }

    class Particle {
        constructor(x, y, hex) {
            this.x = x + random(-10,10); this.y = y + random(-10,10);
            this.vx = random(-3,3); this.vy = random(-3,3);
            this.life = 255; this.color = color(hex);
            this.size = random(8, 15);
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            this.life -= 15; this.size *= 0.9;
        }
        show() {
            noStroke(); this.color.setAlpha(this.life);
            fill(this.color); ellipse(this.x, this.y, this.size);
        }
    }

    function handleParticles() {
        for (let i = particles.length-1; i >= 0; i--) {
            particles[i].update(); particles[i].show();
            if (particles[i].life <= 0) particles.splice(i,1);
        }
    }

    function winEffect() {
        if(frameCount % 10 === 0) particles.push(new Particle(random(width), random(height), vocabulary[currentIndex].color));
    }

    // æ‰‹æ©Ÿé˜²æ»‘å‹•
    document.addEventListener('touchmove', function(e) {
        // å…è¨±é¸å–®å€ (menu-layer) å…§çš„æ»‘å‹•ï¼Œç¦æ­¢å…¶ä»–åœ°æ–¹
        if (document.getElementById('menu-layer').contains(e.target) && document.getElementById('menu-layer').style.display !== 'none') {
            return; 
        }
        if (e.target.tagName !== 'BUTTON') e.preventDefault();
    }, { passive: false });
    
    function touchMoved() { return false; }
</script>
</body>
</html>
