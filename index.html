<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç†Šç†Š é˜¿å‰å¯¶å¯å¤¢ç”Ÿå­—å¤§è€ƒé©—V25</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <style>
        /* --- V25 å…¨å±€èˆ‡åŸºç¤ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: #333; 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            width: 100vw; height: 100dvh; 
            overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* --- 1. é¸å–®å±¤ --- */
        #menu-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #eef2f5;
            background-image: 
                linear-gradient(rgba(255,255,255,0.5) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.5) 2px, transparent 2px);
            background-size: 40px 40px;
            z-index: 50;
            display: flex; flex-direction: column;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }

        .menu-header {
            text-align: center; padding: 20px 10px;
            padding-top: max(20px, env(safe-area-inset-top));
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 51;
            display: flex; flex-direction: column; align-items: center;
            border-bottom: 5px solid #ffcb05;
        }
        .menu-header h1 { margin: 0; font-size: 22px; color: #ffcb05; -webkit-text-stroke: 1px #3b4cca; text-shadow: 2px 2px 0 #3b4cca; }
        .menu-subtitle { font-size: 14px; color: #666; margin-top: 5px; }

        .bgm-toggle {
            margin-top: 10px; padding: 5px 15px; border-radius: 20px;
            border: 2px solid #ccc; background: #fff; color: #666;
            font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .bgm-toggle.active { border-color: #4caf50; color: #4caf50; background: #e8f5e9; }

        #pokemon-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px;
            padding-bottom: 100px; 
        }

        .poke-card {
            background: white; border-radius: 15px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative; min-height: 120px;
            transition: transform 0.1s;
            border: 2px solid transparent;
        }
        .poke-card.unlocked { border-color: #ffcb05; background: #fffdf0; }
        .poke-card:active { transform: scale(0.95); }
        .poke-id { position: absolute; top: 5px; left: 8px; font-size: 10px; color: #999; font-weight: bold; }
        .poke-img { width: 80px; height: 80px; object-fit: contain; margin-top: 10px; }
        .locked .poke-img { filter: brightness(0) opacity(0.3); } 
        .locked .poke-name { color: #ccc; }
        .unlocked .poke-img { filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.6)); }
        .unlocked .poke-name { color: #333; font-weight: bold; }
        .poke-name { margin-top: 5px; font-size: 14px; text-align: center; }

        /* --- 2. éŠæˆ²å±¤ --- */
        #game-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: none; 
            flex-direction: column; 
            background: linear-gradient(180deg, #64B5F6 0%, #BBDEFB 45%, #81C784 45%, #66BB6A 100%);
        }
        
        #game-layer::after {
            content: "";
            position: absolute; top: 45%; left: 0; width: 100%; height: 20px;
            background: rgba(0,0,0,0.1);
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            transform: scaleX(1.5);
            pointer-events: none;
        }

        .game-top-bar {
            padding: 10px; 
            padding-top: max(15px, env(safe-area-inset-top));
            text-align: left; 
            background: rgba(255, 255, 255, 0.85);
            border-radius: 0 0 20px 0;
            width: 70%; 
            box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
            z-index: 20; 
            position: relative; 
        }
        .game-top-bar h2 { margin: 0; font-size: 20px; color: #333; padding-left: 10px; }

        #battle-area {
            position: absolute;
            top: 10%; right: 5%;
            width: 180px; height: 180px;
            display: flex; justify-content: center; align-items: flex-end;
            pointer-events: none;
            z-index: 5;
        }

        .opponent-base {
            position: absolute; bottom: 10px;
            width: 140px; height: 40px;
            background: rgba(0,50,0,0.2);
            border-radius: 50%;
            transform: scaleY(0.5);
        }

        /* V25: å‰ªå½±æ¨£å¼æ§åˆ¶ */
        #battle-silhouette {
            width: 160px; height: 160px;
            object-fit: contain;
            /* é è¨­æ˜¯é»‘å½± */
            filter: brightness(0) opacity(0.6); 
            position: relative;
            z-index: 2;
            transition: filter 0.5s ease-out, transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: breathe 2s ease-in-out infinite;
        }
        /* V25: è§£é–ç‹€æ…‹ classï¼Œç§»é™¤é»‘è‰²æ¿¾é¡ä¸¦ç™¼å…‰ */
        #battle-silhouette.revealed {
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8)) !important;
            transform: scale(1.15) !important;
            animation: none; /* åœæ­¢å‘¼å¸ï¼Œæ”¹ç‚ºå¼·èª¿ */
        }

        @keyframes breathe { 0% { transform: translateY(0); } 50% { transform: translateY(-5px) scale(1.02); } 100% { transform: translateY(0); } }

        #canvas-wrapper {
            flex-grow: 1; 
            position: relative;
            display: flex; align-items: flex-end; justify-content: center; 
            padding-bottom: 20px;
            overflow: hidden;
            touch-action: none; 
            z-index: 10;
        }

        #p5-container {
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.95);
            border: 4px solid #333;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .game-bottom-bar {
            padding: 15px;
            padding-bottom: max(30px, env(safe-area-inset-bottom));
            background: #222; 
            border-top: 4px solid #f8f8f8; 
            flex-shrink: 0; 
            display: flex; flex-direction: column; gap: 15px;
            z-index: 9999; 
            position: relative;
        }

        #progress-container { width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px;}
        .hp-label { color: #ffcb05; font-weight: bold; font-size: 14px; }
        #progress-bar {
            width: 70%; height: 16px; background: #555; border-radius: 10px;
            border: 2px solid #fff; overflow: hidden; position: relative;
        }
        #progress-fill { height: 100%; width: 0%; background: #4caf50; transition: width 0.2s; box-shadow: inset 0 2px 0 rgba(255,255,255,0.3); }

        .btn-group { display: flex; justify-content: center; gap: 15px; }
        .btn {
            background: #fff; border: 2px solid #333; color: #333;
            padding: 10px 20px; font-size: 16px; font-weight: bold; border-radius: 10px;
            cursor: pointer; box-shadow: 4px 4px 0 #555;
            user-select: none; min-width: 80px; 
            touch-action: manipulation;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #555; }
        
        .btn-fight { background: #ff5555; color: white; border-color: #aa0000; box-shadow: 4px 4px 0 #aa0000; }
        .btn-fight:active { box-shadow: 2px 2px 0 #aa0000; }
        
        .btn-next { background: #ffcb05; color: #333; border-color: #c59d00; box-shadow: 4px 4px 0 #c59d00; }
        .btn-next:active { box-shadow: 2px 2px 0 #c59d00; }

        /* --- å¯¶è²çƒå‹•ç•«èˆ‡ CSS --- */
        #pokeball-anim-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5000;
            display: none; justify-content: center; align-items: center;
        }
        .pokeball-css {
            width: 50px; height: 50px;
            background: white;
            border: 3px solid #333;
            border-radius: 50%;
            position: absolute;
            bottom: 100px; /* èµ·å§‹ä½ç½® */
            background-image: linear-gradient(to bottom, #f00 48%, #333 48%, #333 52%, #fff 52%);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .pokeball-css::after {
            content: ""; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 16px; height: 16px;
            background: white; border: 2px solid #333; border-radius: 50%;
            z-index: 2;
        }
        
        /* V25: ä¿®æ­£ä¸Ÿçƒè»Œè·¡ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ˜¯ä¸Ÿå‘æˆ°é¬¥å€å¡Š */
        @keyframes throwBall {
            0% { transform: translateY(400px) scale(1.5) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-120px) scale(0.6) rotate(360deg); opacity: 1; } /* æ“Šä¸­é» */
            60% { transform: translateY(-120px) scale(1.2); opacity: 1; } /* æ’æ“Šæ”¾å¤§ */
            70% { transform: translateY(-120px) scale(0) rotate(720deg); opacity: 0; } /* æ¶ˆå¤± */
            100% { opacity: 0; }
        }
        .anim-throw {
            animation: throwBall 1.0s ease-in-out forwards;
        }

        /* --- çå‹µå¡ç‰‡ --- */
        #reward-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 10000;
            display: none; justify-content: center; align-items: center;
        }
        .reward-card {
            background: white; padding: 20px; border-radius: 20px;
            text-align: center; width: 85%; max-width: 340px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); 
            border: 5px solid #3b4cca;
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .reward-card::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background: radial-gradient(circle at 50% 50%, #f0f0f0 10%, transparent 10%),
                        linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: -1; border-radius: 15px;
        }
        
        .reward-card img { width: 180px; height: 180px; object-fit: contain; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
        .reward-text { font-size: 24px; font-weight: bold; color: #3b4cca; margin: 5px 0; }
        
        .poke-stats {
            background: #333; border-radius: 10px; padding: 10px; margin: 10px 0;
            display: flex; justify-content: space-around; font-size: 13px; color: #fff;
            text-align: left; border: 2px solid #555;
        }
        .poke-stats div { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; color: #aaa; margin-bottom: 2px; }
        .stat-val { font-weight: bold; color: #ffcb05; }
        
        @keyframes popUp { from { transform: scale(0.5); } to { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="youtube-player" style="position: absolute; top: -9999px; left: -9999px;"></div>
    
    <audio id="cry-player"></audio>

    <div id="menu-layer">
        <div class="menu-header">
            <h1>ğŸ» ç†Šç†Š é˜¿å‰ ğŸ‘¸<br>å¯¶å¯å¤¢ç”Ÿå­—å¤§è€ƒé©—V25</h1>
            <div class="menu-subtitle">é»æ“Šé»‘è‰²å½±å­é–‹å§‹æŒ‘æˆ°ï¼</div>
            <button class="bgm-toggle" id="bgm-btn" onclick="toggleBGM()">
                <span>ğŸµ éŸ³æ¨‚ï¼šé—œ</span>
            </button>
        </div>
        <div id="pokemon-grid"></div>
    </div>

    <div id="game-layer">
        <div id="battle-area">
            <div class="opponent-base"></div>
            <img id="battle-silhouette" src="" alt="Wild Pokemon">
        </div>

        <div class="game-top-bar">
            <h2 id="question-text">é‡ç”Ÿå¯¶å¯å¤¢ å‡ºç¾äº†ï¼</h2>
        </div>
        
        <div id="canvas-wrapper">
            <div id="p5-container"></div>
        </div>
        
        <div class="game-bottom-bar">
            <div id="progress-container">
                <span class="hp-label">HP</span>
                <div id="progress-bar"><div id="progress-fill"></div></div>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="returnToMenu()">é€ƒè·‘</button>
                <button class="btn" onclick="resetCanvas(true)">é‡å¯«</button>
                <button class="btn btn-fight" id="next-btn" onclick="nextStep()">æ”»æ“Š</button>
            </div>
        </div>
        
        <div id="pokeball-anim-layer">
            <div id="anim-ball" class="pokeball-css"></div>
        </div>
    </div>

    <div id="reward-popup">
        <div class="reward-card">
            <h2 style="color:#ffcb05; -webkit-text-stroke:1px #3b4cca; margin:0;">GOTCHA!</h2>
            <img id="reward-img" src="" alt="">
            <div class="reward-text" id="reward-msg">æ•ç²æˆåŠŸ!</div>
            
            <div class="poke-stats" id="poke-stats-box">
                <div><span class="stat-label">å±¬æ€§</span><span class="stat-val" id="stat-type">--</span></div>
                <div><span class="stat-label">èº«é«˜</span><span class="stat-val" id="stat-height">-- m</span></div>
                <div><span class="stat-label">é«”é‡</span><span class="stat-val" id="stat-weight">-- kg</span></div>
            </div>

            <button class="btn btn-next" onclick="closeRewardAndReturn()">æ”¶å…¥åœ–é‘‘</button>
        </div>
    </div>

<script>
    const vocabulary = [
        { word: "çš®å¡ä¸˜", zhuyin: ["ã„†ã„§ËŠ","ã„ã„šË‡","ã„‘ã„§ã„¡"], color: "#F7D02C", imageId: "25", id: 25 },
        { word: "è·¯å¡åˆ©æ­", zhuyin: ["ã„Œã„¨Ë‹","ã„ã„šË‡","ã„Œã„§Ë‹","ã„¡"], color: "#448CCB", imageId: "448", id: 448 },
        { word: "ä¼Šå¸ƒ", zhuyin: ["ã„§","ã„…ã„¨Ë‹"], color: "#A8A77A", imageId: "133", id: 133 },
        { word: "æ°´ä¼Šå¸ƒ", zhuyin: ["ã„•ã„¨ã„ŸË‡","ã„§","ã„…ã„¨Ë‹"], color: "#6890F0", imageId: "134", id: 134 },
        { word: "é›·ä¼Šå¸ƒ", zhuyin: ["ã„Œã„ŸËŠ","ã„§","ã„…ã„¨Ë‹"], color: "#F8D030", imageId: "135", id: 135 },
        { word: "ç«ä¼Šå¸ƒ", zhuyin: ["ã„ã„¨ã„›Ë‡","ã„§","ã„…ã„¨Ë‹"], color: "#F08030", imageId: "136", id: 136 },
        { word: "å¤ªé™½ä¼Šå¸ƒ", zhuyin: ["ã„Šã„Ë‹","ã„§ã„¤ËŠ","ã„§","ã„…ã„¨Ë‹"], color: "#A890F0", imageId: "196", id: 196 },
        { word: "æœˆäº®ä¼Šå¸ƒ", zhuyin: ["ã„©ã„Ë‹","ã„Œã„§ã„¤Ë‹","ã„§","ã„…ã„¨Ë‹"], color: "#705848", imageId: "197", id: 197 },
        { word: "è‘‰ä¼Šå¸ƒ", zhuyin: ["ã„§ã„Ë‹","ã„§","ã„…ã„¨Ë‹"], color: "#78C850", imageId: "470", id: 470 },
        { word: "å†°ä¼Šå¸ƒ", zhuyin: ["ã„…ã„§ã„¥","ã„§","ã„…ã„¨Ë‹"], color: "#98D8D8", imageId: "471", id: 471 },
        { word: "ä»™å­ä¼Šå¸ƒ", zhuyin: ["ã„’ã„§ã„¢","ã„—Ë‡","ã„§","ã„…ã„¨Ë‹"], color: "#F85888", imageId: "700", id: 700 },
        { word: "å¦™è›™ç¨®å­", zhuyin: ["ã„‡ã„§ã„ Ë‹","ã„¨ã„š","ã„“ã„¨ã„¥Ë‡","ã„—Ë‡"], color: "#78C850", imageId: "1", id: 1 },
        { word: "å°ç«é¾", zhuyin: ["ã„’ã„§ã„ Ë‡","ã„ã„¨ã„›Ë‡","ã„Œã„¨ã„¥ËŠ"], color: "#F08030", imageId: "4", id: 4 },
        { word: "å‚‘å°¼é¾œ", zhuyin: ["ã„ã„§ã„ËŠ","ã„‹ã„§ËŠ","ã„ã„¨ã„Ÿ"], color: "#6890F0", imageId: "7", id: 7 },
        { word: "å¡æ¯”ç¸", zhuyin: ["ã„ã„šË‡","ã„…ã„§Ë‡","ã„•ã„¡Ë‹"], color: "#303842", imageId: "143", id: 143 },
        { word: "å¿«é¾", zhuyin: ["ã„ã„¨ã„Ë‹","ã„Œã„¨ã„¥ËŠ"], color: "#F0B666", imageId: "149", id: 149 },
        { word: "è¶…å¤¢", zhuyin: ["ã„”ã„ ","ã„‡ã„¥Ë‹"], color: "#9668C9", imageId: "150", id: 150 },
        { word: "å¤¢å¹»", zhuyin: ["ã„‡ã„¥Ë‹","ã„ã„¨ã„¢Ë‹"], color: "#F85888", imageId: "151", id: 151 },
        { word: "æ³¢å…‹æ¯”", zhuyin: ["ã„…ã„›","ã„ã„œË‹","ã„…ã„§Ë‡"], color: "#F85888", imageId: "175", id: 175 },
        { word: "å¯é”é´¨", zhuyin: ["ã„ã„œË‡","ã„‰ã„šËŠ","ã„§ã„š"], color: "#F8D030", imageId: "54", id: 54 }
    ];

    const typeMap = {
        normal: "ä¸€èˆ¬", fire: "ç«", water: "æ°´", grass: "è‰", electric: "é›»",
        ice: "å†°", fighting: "æ ¼é¬¥", poison: "æ¯’", ground: "åœ°é¢", flying: "é£›è¡Œ",
        psychic: "è¶…èƒ½", bug: "èŸ²", rock: "å²©çŸ³", ghost: "å¹½éˆ", dragon: "é¾",
        steel: "é‹¼", dark: "æƒ¡", fairy: "å¦–ç²¾"
    };

    let isMusicOn = false;
    let ytPlayer;

    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('youtube-player', {
            height: '0', width: '0',
            videoId: 'nQ5Cy-HU8TQ',
            playerVars: { 'autoplay': 0, 'loop': 1, 'playlist': 'nQ5Cy-HU8TQ' },
            events: { 'onReady': onPlayerReady }
        });
    }

    function onPlayerReady(event) { console.log("YouTube Player Ready"); }

    function toggleBGM() {
        if (!ytPlayer || !ytPlayer.playVideo) return;
        isMusicOn = !isMusicOn;
        const btn = document.getElementById('bgm-btn');
        if(isMusicOn) {
            btn.classList.add('active');
            btn.innerHTML = '<span>ğŸµ éŸ³æ¨‚ï¼šé–‹</span>';
            ytPlayer.playVideo();
        } else {
            btn.classList.remove('active');
            btn.innerHTML = '<span>ğŸµ éŸ³æ¨‚ï¼šé—œ</span>';
            ytPlayer.pauseVideo();
        }
    }

    vocabulary.forEach(v => v.isUnlocked = false);

    function initMenu() {
        const grid = document.getElementById('pokemon-grid');
        grid.innerHTML = ''; 
        vocabulary.forEach((poke, index) => {
            const card = document.createElement('div');
            card.className = `poke-card ${poke.isUnlocked ? 'unlocked' : 'locked'}`;
            card.onclick = () => startGame(index);

            const idTag = document.createElement('div');
            idTag.className = 'poke-id';
            idTag.innerText = 'No.' + String(poke.id).padStart(3, '0');

            const img = document.createElement('img');
            img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${poke.imageId}.png`;
            img.className = 'poke-img';
            img.loading = "lazy";

            const name = document.createElement('div');
            name.className = 'poke-name';
            name.innerText = poke.isUnlocked ? poke.word : "???";

            card.appendChild(idTag);
            card.appendChild(img);
            card.appendChild(name);
            grid.appendChild(card);
        });
    }
    document.addEventListener("DOMContentLoaded", initMenu);

    let currentIndex = -1; 
    let charIndex = 0;
    let pgTarget, pgDraw;
    let particles = [];
    let canvasSize;
    let isWin = false;
    let isTransitioning = false;
    let STROKE_SIZE = 18;
    let TARGET_FONT_SIZE, ZHUYIN_FONT_SIZE;
    let pX = 0, pY = 0;
    let isDrawing = false; 

    function setup() {
        pixelDensity(1); 
        let w = window.innerWidth;
        let h = window.innerHeight;
        let availableH = h - 300; 
        canvasSize = Math.min(w - 40, availableH); 
        
        let cnv = createCanvas(canvasSize, canvasSize);
        cnv.parent('p5-container');

        let canvasEl = cnv.elt;
        
        canvasEl.addEventListener('touchstart', function(e) {
            e.preventDefault(); 
            if(isWin || isTransitioning) return; 
            isDrawing = true;
            let rect = canvasEl.getBoundingClientRect();
            let touch = e.touches[0];
            let x = touch.clientX - rect.left;
            let y = touch.clientY - rect.top;
            pX = x; pY = y;
            if(currentIndex >= 0) {
                pgDraw.stroke(vocabulary[currentIndex].color);
                pgDraw.strokeWeight(STROKE_SIZE);
                pgDraw.point(x, y);
            }
        }, { passive: false });

        canvasEl.addEventListener('touchmove', function(e) {
            e.preventDefault(); 
            if (!isDrawing || isWin || isTransitioning) return;
            let rect = canvasEl.getBoundingClientRect();
            let touch = e.touches[0];
            let x = touch.clientX - rect.left;
            let y = touch.clientY - rect.top;
            if(currentIndex >= 0) {
                pgDraw.stroke(vocabulary[currentIndex].color);
                pgDraw.strokeWeight(STROKE_SIZE);
                pgDraw.strokeCap(ROUND); pgDraw.strokeJoin(ROUND);
                pgDraw.line(pX, pY, x, y);
                if (dist(pX, pY, x, y) > 5) {
                    particles.push(new Particle(x, y, vocabulary[currentIndex].color));
                }
            }
            pX = x; pY = y;
        }, { passive: false });

        canvasEl.addEventListener('touchend', function(e) { 
            isDrawing = false; 
            if(currentIndex >= 0 && !isWin && !isTransitioning) {
                checkWinCondition(); 
            }
        }, { passive: false });

        canvasEl.addEventListener('mousedown', function(e) { isDrawing = true; pX = mouseX; pY = mouseY; });

        TARGET_FONT_SIZE = canvasSize * 0.55;
        ZHUYIN_FONT_SIZE = TARGET_FONT_SIZE * 0.22;
        pgTarget = createGraphics(canvasSize, canvasSize);
        pgDraw = createGraphics(canvasSize, canvasSize);
        let fontName = "-apple-system, 'Microsoft JhengHei', sans-serif";
        textFont(fontName);
        pgTarget.textFont(fontName);
    }

    function draw() {
        if (currentIndex === -1 || document.getElementById('game-layer').style.display === 'none') return;

        background(255);
        drawGrid();
        drawGuideCharacter();
        image(pgDraw, 0, 0);
        handleParticles();

        if (mouseIsPressed && isDrawing && !touches.length && !isWin && !isTransitioning) {
             pgDraw.stroke(vocabulary[currentIndex].color);
             pgDraw.strokeWeight(STROKE_SIZE);
             pgDraw.strokeCap(ROUND); pgDraw.strokeJoin(ROUND);
             pgDraw.line(pmouseX, pmouseY, mouseX, mouseY);
        }
        
        if (isWin) {
            winEffect();
        }
    }

    function startGame(index) {
        currentIndex = index;
        charIndex = 0;
        isWin = false;
        isTransitioning = false;
        
        if(isMusicOn && ytPlayer && ytPlayer.playVideo) { ytPlayer.playVideo(); }

        const silhouette = document.getElementById('battle-silhouette');
        silhouette.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${vocabulary[index].imageId}.png`;
        
        // V25: é‡ç½®å‰ªå½±ç‹€æ…‹ (è®Šå›é»‘å½±)
        silhouette.classList.remove('revealed');

        document.getElementById('menu-layer').style.display = 'none';
        document.getElementById('game-layer').style.display = 'flex';
        
        resetCanvas(true); 
        prepareLevel();
        updateGameUI();
    }

    window.returnToMenu = function() {
        currentIndex = -1; 
        isWin = false;
        isTransitioning = false;
        document.getElementById('game-layer').style.display = 'none';
        document.getElementById('menu-layer').style.display = 'flex';
        pgDraw.clear();
        refreshMenuStatus();
    };
    
    function refreshMenuStatus() {
        const cards = document.querySelectorAll('.poke-card');
        cards.forEach((card, index) => {
            if(vocabulary[index].isUnlocked) {
                card.className = 'poke-card unlocked';
                card.querySelector('.poke-name').innerText = vocabulary[index].word;
            }
        });
    }

    window.resetCanvas = function(force = false) {
        if(!force && isTransitioning) return;
        pgDraw.clear();
        isWin = false;
        document.getElementById("progress-fill").style.width = "0%";
        document.getElementById("progress-fill").style.background = "#4caf50";
    };

    window.nextStep = function() {
        if (charIndex < vocabulary[currentIndex].word.length - 1) {
            performNextStep();
        } else {
            // V25: è§¸ç™¼æ•æ‰å‹•ç•« (å«æ­ç¤ºæ•ˆæœ)
            triggerCaptureSequence();
        }
    };

    function performNextStep() {
        charIndex++;
        isWin = false;
        isTransitioning = false;
        pgDraw.clear(); 
        prepareLevel(); 
        updateGameUI();
    }
    
    window.closeRewardAndReturn = function() {
        document.getElementById("reward-popup").style.display = "none";
        returnToMenu();
    };

    function prepareLevel() {
        pgDraw.clear();
        pgTarget.clear();
        pgTarget.fill(0); pgTarget.noStroke(); pgTarget.textAlign(CENTER, CENTER);
        
        let data = vocabulary[currentIndex];
        let char = data.word[charIndex];
        pgTarget.textSize(TARGET_FONT_SIZE);
        pgTarget.text(char, width/2 - TARGET_FONT_SIZE*0.15, height/2 - TARGET_FONT_SIZE*0.05);

        let nextBtn = document.getElementById("next-btn");
        nextBtn.innerText = "æ”»æ“Š";
        nextBtn.style.display = "block";
        document.getElementById("progress-fill").style.width = "0%";
        document.getElementById("progress-fill").style.background = "#4caf50";
    }

    function drawGuideCharacter() {
        if(currentIndex === -1) return;
        let data = vocabulary[currentIndex];
        let char = data.word[charIndex];
        let zhuyinStr = data.zhuyin[charIndex];
        let charX = width/2 - TARGET_FONT_SIZE*0.15;
        let charY = height/2 - TARGET_FONT_SIZE*0.05;

        push();
        textAlign(CENTER, CENTER);
        fill(240); noStroke(); textSize(TARGET_FONT_SIZE); text(char, charX, charY);
        noFill(); stroke(220); strokeWeight(3); text(char, charX, charY);

        let zhuyinX = charX + TARGET_FONT_SIZE * 0.65;
        let totalHeight = zhuyinStr.length * ZHUYIN_FONT_SIZE * 1.1; 
        let startY = charY - (totalHeight / 2) + (ZHUYIN_FONT_SIZE/2);
        fill(100); noStroke(); textSize(ZHUYIN_FONT_SIZE);
        for (let i = 0; i < zhuyinStr.length; i++) {
            text(zhuyinStr[i], zhuyinX, startY + (i * ZHUYIN_FONT_SIZE * 1.1));
        }
        pop();
    }

    function checkWinCondition() {
        pgTarget.loadPixels(); pgDraw.loadPixels();
        let targetCount = 0, coveredCount = 0;
        const step = 4; 
        for (let i = 0; i < pgTarget.pixels.length; i += step) {
            if (pgTarget.pixels[i+3] > 150) {
                targetCount++;
                if (pgDraw.pixels[i+3] > 100) coveredCount++;
            }
        }
        let ratio = targetCount > 0 ? coveredCount / targetCount : 0;
        let percent = Math.min(Math.floor(ratio * 100), 100);
        document.getElementById("progress-fill").style.width = percent + "%";
        if (ratio > 0.85) { gameWin(); }
    }

    function gameWin() {
        if (isWin || isTransitioning) return;
        isWin = true;
        isTransitioning = true; 
        document.getElementById("progress-fill").style.background = "linear-gradient(90deg, #FFD700, #FFA500)";
        for(let i=0; i<30; i++) particles.push(new Particle(width/2, height/2, vocabulary[currentIndex].color));

        setTimeout(() => {
            if (charIndex < vocabulary[currentIndex].word.length - 1) {
                performNextStep();
            } else {
                document.getElementById("next-btn").innerText = "ä¸Ÿçƒ!";
            }
        }, 1500); 
    }

    // --- V25: å¼·åŒ–ç‰ˆä¸Ÿçƒèˆ‡æ­ç¤ºå‹•ç•« ---
    function triggerCaptureSequence() {
        const animLayer = document.getElementById('pokeball-anim-layer');
        const ball = document.getElementById('anim-ball');
        const silhouette = document.getElementById('battle-silhouette');
        
        // 1. é¡¯ç¤ºå‹•ç•«å±¤ä¸¦é‡ç½®å‹•ç•«
        animLayer.style.display = 'flex';
        ball.classList.remove('anim-throw');
        void ball.offsetWidth; // å¼·åˆ¶é‡ç¹ª
        ball.classList.add('anim-throw');

        // 2. è¨­å®šåœ¨çƒæ“Šä¸­æ™‚ (ç´„ 500ms) æ­ç¤ºçœŸé¢ç›®
        setTimeout(() => {
            // è§£é™¤é»‘å½±ï¼Œè®Šå½©è‰²
            silhouette.classList.add('revealed');
            
            // æ’­æ”¾å«è² (ç§»åˆ°é€™è£¡ï¼Œæ›´æœ‰æ“Šä¸­/è§£é–çš„æ„Ÿè¦º)
            const cryAudio = document.getElementById("cry-player");
            let data = vocabulary[currentIndex];
            cryAudio.src = `https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/${data.id}.ogg`;
            cryAudio.volume = 0.6;
            cryAudio.play().catch(e=>console.log("å«è²æ’­æ”¾å¤±æ•—"));
            
        }, 500);

        // 3. å‹•ç•«çµæŸå¾Œ (æ¬£è³ä¸€ä¸‹å½©è‰²æ¨£å­) å†é¡¯ç¤ºå¡ç‰‡ (ç´„ 1.5ç§’å¾Œ)
        setTimeout(() => {
            animLayer.style.display = 'none';
            showReward();
        }, 1500);
    }

    function showReward() {
        let data = vocabulary[currentIndex];
        document.getElementById("reward-img").src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${data.imageId}.png`;
        document.getElementById("reward-msg").innerText = `æ•ç² ${data.word} !`;
        
        document.getElementById("stat-type").innerText = "è®€å–ä¸­...";
        document.getElementById("stat-height").innerText = "-- m";
        document.getElementById("stat-weight").innerText = "-- kg";

        document.getElementById("reward-popup").style.display = "flex";
        vocabulary[currentIndex].isUnlocked = true;
        for(let i=0; i<50; i++) particles.push(new Particle(random(width), random(height), data.color));

        fetch(`https://pokeapi.co/api/v2/pokemon/${data.id}`)
            .then(res => res.json())
            .then(pokeData => {
                const h = pokeData.height / 10;
                const w = pokeData.weight / 10;
                const types = pokeData.types.map(t => typeMap[t.type.name] || t.type.name).join("/");
                document.getElementById("stat-type").innerText = types;
                document.getElementById("stat-height").innerText = h + " m";
                document.getElementById("stat-weight").innerText = w + " kg";
            })
            .catch(err => {
                console.error("Data load failed", err);
                document.getElementById("stat-type").innerText = "æœªçŸ¥";
            });
    }

    function updateGameUI() {
        let data = vocabulary[currentIndex];
        document.getElementById('question-text').innerHTML = `
            é‡ç”Ÿ <span style="color:#d32f2f; font-weight:bold;">${data.word}</span> å‡ºç¾äº†ï¼
        `;
    }

    function drawGrid() {
        push(); stroke(230); strokeWeight(2);
        rect(1, 1, width-2, height-2);
        drawingContext.setLineDash([8, 8]);
        line(width/2, 0, width/2, height);
        line(0, height/2, width, height/2);
        pop();
    }

    class Particle {
        constructor(x, y, hex) {
            this.x = x + random(-10,10); this.y = y + random(-10,10);
            this.vx = random(-3,3); this.vy = random(-3,3);
            this.life = 255; this.color = color(hex); this.size = random(8, 15);
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= 15; this.size *= 0.9; }
        show() { noStroke(); this.color.setAlpha(this.life); fill(this.color); ellipse(this.x, this.y, this.size); }
    }

    function handleParticles() {
        for (let i = particles.length-1; i >= 0; i--) {
            particles[i].update(); particles[i].show();
            if (particles[i].life <= 0) particles.splice(i,1);
        }
    }
    
    function winEffect() {
        if(frameCount % 10 === 0) particles.push(new Particle(random(width), random(height), vocabulary[currentIndex].color));
    }
</script>
</body>
</html>
